<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulateur de crédit Paositra Finances</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f8f9fa;
    font-size: 14px;
    color: #333;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    text-align: center;
  }
  .logo { height: 60px; max-width: 50%; }
  .title { font-size: 1.8rem; color: #2c3e50; margin: 0; }
  @media (max-width: 600px) {
    .title { font-size: 1.4rem; }
    .logo { height: 50px; }
  }

  .form-container {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  label { font-weight: bold; margin-top: 8px; display: block; }
  select, input, button {
    padding: 8px;
    margin-top: 5px;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 100%;
    font-size: 14px;
    box-sizing: border-box;
  }
  
  .mode-toggle {
    background: #e8f4f8;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  
  .radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
  }
  
  .radio-group label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: normal;
  }
  
  .radio-group input[type="radio"] {
    width: auto;
    margin: 0;
  }
  
  .custom-payments-section {
    background: #fff3cd;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    display: none;
  }
  
  .payment-period {
    background: white;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
  }
  
  .payment-period-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .payment-period input {
    width: calc(50% - 5px);
    display: inline-block;
  }
  
  .btn-small {
    padding: 5px 10px;
    font-size: 12px;
    width: auto;
    margin: 0;
  }
  
  .btn-danger {
    background: #dc3545;
  }
  
  .btn-danger:hover {
    background: #c82333;
  }
  
  .btn-success {
    background: #28a745;
  }
  
  .btn-success:hover {
    background: #218838;
  }
  
  button {
    background: #3498db;
    color: #fff;
    cursor: pointer;
    font-weight: bold;
    margin-top: 15px;
    border: none;
  }
  button:hover { background: #2980b9; }

  .result-box {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  .warning-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    color: #856404;
    font-size: 13px;
  }
  
  .info-box {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    color: #0c5460;
    font-size: 13px;
  }
  
  .success-box {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    color: #155724;
    font-size: 13px;
  }
  
  .btn-export {
    background: #28a745;
    margin-left: 10px;
  }
  
  .btn-export:hover {
    background: #218838;
  }
  
  .btn-print {
    background: #6c757d;
    margin-left: 10px;
  }
  
  .btn-print:hover {
    background: #5a6268;
  }
  
  .actions-bar {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
  }
  
  .actions-bar button {
    flex: 1;
    min-width: 150px;
  }
  
  @media print {
    .form-container, .actions-bar, button {
      display: none !important;
    }
    .container {
      max-width: 100%;
    }
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: right;
    font-size: 12px;
    overflow: hidden;
  }
  th { background: #2c3e50; color: white; text-align: center; }
  td:first-child, th:first-child { width: 10%; }
  td:nth-child(2), th:nth-child(2) { width: 25%; }
  td:nth-child(3), th:nth-child(3) { width: 20%; }
  td:nth-child(4), th:nth-child(4) { width: 20%; }
  td:nth-child(5), th:nth-child(5) { width: 25%; }
  tr:nth-child(even) { background: #f2f2f2; }
  tr:hover { background: #eaf2f8; }
  .grace { background: #ffeeba !important; }
  .custom-period { background: #d4edda !important; }
  .custom-period.grace { background: #fff3cd !important; border-left: 4px solid #ff9800; }
  .total-row { font-weight: bold; background: #dff0d8; }
  .summary { font-size: 14px; line-height: 1.6; }
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1 class="title">Simulateur de crédit Paositra Finances</h1>
  </header>

  <div class="form-container">
    <label for="produit">Choisir un produit :</label>
    <select id="produit" onchange="updateProduit()">
      <option value="">-- Sélectionnez --</option>
      <option value="KETRIKA">KETRIKA</option>
      <option value="HERIJIKA">HERIJIKA</option>
      <option value="HERIJIKA_PLUS">HERIJIKA PLUS</option>
      <option value="HERIJIKA_PME">HERIJIKA PME</option>
    </select>

    <label for="montant">Montant du prêt (Ariary):</label>
    <input type="number" id="montant">

    <label for="taux">Taux d'intérêt annuel (%):</label>
    <input type="number" id="taux" step="0.01">

    <label for="duree">Durée (mois):</label>
    <input type="number" id="duree">

    <label for="periodeGrace">Période de grâce (mois):</label>
    <input type="number" id="periodeGrace" value="0">
    
    <div class="mode-toggle">
      <label style="margin-bottom: 10px;">Mode de remboursement :</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="mode" value="standard" checked onchange="toggleCustomPayments()">
          Mensualités fixes
        </label>
        <label>
          <input type="radio" name="mode" value="custom" onchange="toggleCustomPayments()">
          Mensualités personnalisées
        </label>
      </div>
    </div>
    
    <div id="customPaymentsSection" class="custom-payments-section">
      <h3 style="margin-top: 0;">Configuration des mensualités personnalisées</h3>
      <p style="font-size: 12px; color: #666;">Définissez différents montants de mensualités pour différentes périodes de remboursement.</p>
      
      <div id="paymentPeriods"></div>
      
      <button type="button" class="btn-success" onclick="addPaymentPeriod()">+ Ajouter une période</button>
    </div>

    <button onclick="calculer()">Calculer</button>
  </div>

  <div id="result" class="result-box"></div>
  <div id="resultMensualite" class="result-box"></div>
  <div id="tableauAmortissement"></div>
</div>

<script>
const produits = {
  KETRIKA: { taux: 39, min: 515000, max: 10300000, minDuree: 6, maxDuree: 30 },
  HERIJIKA: { taux: 39, min: 1030000, max: 10300000, minDuree: 6, maxDuree: 24 },
  HERIJIKA_PLUS: { taux: 39, min: 10300001, max: 51500000, minDuree: 6, maxDuree: 24 },
  HERIJIKA_PME: { taux: null, min: 51500001, max: 154500000, minDuree: 6, maxDuree: 24 }
};

let paymentPeriods = [];

function updateProduit() {
  const produit = document.getElementById('produit').value;
  const tauxInput = document.getElementById('taux');
  if (produit && produits[produit].taux !== null) {
    tauxInput.value = produits[produit].taux;
    tauxInput.disabled = true;
  } else {
    tauxInput.value = "";
    tauxInput.disabled = false;
  }
}

function formatAriary(val) {
  return val.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " Ar";
}

function toggleCustomPayments() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const section = document.getElementById('customPaymentsSection');
  
  if (mode === 'custom') {
    section.style.display = 'block';
    if (paymentPeriods.length === 0) {
      addPaymentPeriod();
    }
  } else {
    section.style.display = 'none';
  }
}

function addPaymentPeriod() {
  const id = Date.now();
  paymentPeriods.push({ id, startMonth: 1, endMonth: 1, amount: 0 });
  renderPaymentPeriods();
}

function removePaymentPeriod(id) {
  paymentPeriods = paymentPeriods.filter(p => p.id !== id);
  renderPaymentPeriods();
}

function renderPaymentPeriods() {
  const container = document.getElementById('paymentPeriods');
  container.innerHTML = paymentPeriods.map((period, index) => `
    <div class="payment-period">
      <div class="payment-period-header">
        <strong>Période ${index + 1}</strong>
        ${paymentPeriods.length > 1 ? `<button type="button" class="btn-small btn-danger" onclick="removePaymentPeriod(${period.id})">Supprimer</button>` : ''}
      </div>
      <label style="font-weight: normal; font-size: 12px;">Du mois</label>
      <input type="number" min="1" value="${period.startMonth}" onchange="updatePeriod(${period.id}, 'startMonth', this.value)">
      <label style="font-weight: normal; font-size: 12px; margin-top: 5px;">Au mois</label>
      <input type="number" min="1" value="${period.endMonth}" onchange="updatePeriod(${period.id}, 'endMonth', this.value)">
      <label style="font-weight: normal; font-size: 12px; margin-top: 5px;">Mensualité (Ariary)</label>
      <input type="number" value="${period.amount}" onchange="updatePeriod(${period.id}, 'amount', this.value)">
    </div>
  `).join('');
}

function updatePeriod(id, field, value) {
  const period = paymentPeriods.find(p => p.id === id);
  if (period) {
    period[field] = field === 'amount' ? parseFloat(value) : parseInt(value);
  }
}

function calculer() {
  const produit = document.getElementById('produit').value;
  const montant = parseFloat(document.getElementById('montant').value);
  const taux = parseFloat(document.getElementById('taux').value)/100;
  const duree = parseInt(document.getElementById('duree').value);
  const periodeGrace = parseInt(document.getElementById('periodeGrace').value);
  const mode = document.querySelector('input[name="mode"]:checked').value;

  if (!produit || isNaN(montant) || isNaN(taux) || isNaN(duree)) {
    alert("Veuillez remplir tous les champs correctement.");
    return;
  }
  if (periodeGrace >= duree) {
    alert("La période de grâce doit être inférieure à la durée.");
    return;
  }

  const conditions = produits[produit];
  if (montant < conditions.min || montant > conditions.max || duree < conditions.minDuree || duree > conditions.maxDuree) {
    alert(`Conditions non respectées pour ${produit}. Montant: ${formatAriary(conditions.min)} à ${formatAriary(conditions.max)}, Durée: ${conditions.minDuree} à ${conditions.maxDuree} mois.`);
    return;
  }

  const tauxMensuel = taux/12;
  const dureeRestante = duree - periodeGrace;

  if (mode === 'standard') {
    calculerModeStandard(montant, tauxMensuel, duree, periodeGrace, dureeRestante, produit, taux);
  } else {
    calculerModePersonnalise(montant, tauxMensuel, duree, periodeGrace, produit, taux);
  }
}

function calculerModeStandard(montant, tauxMensuel, duree, periodeGrace, dureeRestante, produit, taux) {
  const mensualite = montant * tauxMensuel / (1 - Math.pow(1 + tauxMensuel, -dureeRestante));

  let capitalRestant = montant;
  let totalPrincipal = 0, totalInterets = 0, totalMensualites = 0;
  let tableau = `<table>
    <thead><tr>
      <th>Mois</th>
      <th>Capital restant</th>
      <th>Principal</th>
      <th>Intérêt</th>
      <th>Mensualité</th>
    </tr></thead><tbody>`;

  for (let mois = 1; mois <= duree; mois++) {
    let interets, principal, paiement;
    if (mois <= periodeGrace) {
      interets = capitalRestant * tauxMensuel;
      principal = 0;
      paiement = interets;
      tableau += `<tr class="grace"><td>${mois}</td><td>${formatAriary(capitalRestant)}</td><td>${formatAriary(principal)}</td><td>${formatAriary(interets)}</td><td>${formatAriary(paiement)}</td></tr>`;
    } else {
      interets = capitalRestant * tauxMensuel;
      principal = mensualite - interets;
      capitalRestant -= principal;
      paiement = mensualite;
      tableau += `<tr><td>${mois}</td><td>${formatAriary(Math.max(capitalRestant,0))}</td><td>${formatAriary(principal)}</td><td>${formatAriary(interets)}</td><td>${formatAriary(paiement)}</td></tr>`;
    }
    totalPrincipal += principal;
    totalInterets += interets;
    totalMensualites += paiement;
  }

  tableau += `<tr class="total-row"><td>Total</td><td>-</td><td>${formatAriary(totalPrincipal)}</td><td>${formatAriary(totalInterets)}</td><td>${formatAriary(totalMensualites)}</td></tr>`;
  tableau += "</tbody></table>";

  document.getElementById('result').innerHTML =
    `<div class="summary">
      <b>Produit :</b> ${produit}<br>
      <b>Montant emprunté :</b> ${formatAriary(montant)}<br>
      <b>Durée :</b> ${duree} mois (${periodeGrace} mois de grâce)<br>
      <b>Taux annuel :</b> ${(taux*100).toFixed(2)}%<br>
      <b>Total intérêts :</b> ${formatAriary(totalInterets)}<br>
      <b>Coût total du crédit :</b> ${formatAriary(totalMensualites)}
    </div>`;

  document.getElementById('resultMensualite').innerHTML =
    `<b>Mensualité après période de grâce :</b> ${formatAriary(mensualite)}`;

  document.getElementById('tableauAmortissement').innerHTML = tableau;
}

function calculerModePersonnalise(montant, tauxMensuel, duree, periodeGrace, produit, taux) {
  // Validation des périodes personnalisées
  const sortedPeriods = [...paymentPeriods].sort((a, b) => a.startMonth - b.startMonth);
  
  for (let period of sortedPeriods) {
    if (period.startMonth < 1 || period.endMonth > duree || period.startMonth > period.endMonth) {
      alert("Les périodes de paiement doivent être valides et dans la durée du prêt.");
      return;
    }
    if (period.startMonth <= periodeGrace) {
      alert("Les périodes de paiement personnalisées ne peuvent pas commencer pendant la période de grâce.");
      return;
    }
  }

  let capitalRestant = montant;
  let totalPrincipal = 0, totalInterets = 0, totalMensualites = 0;
  let adjustments = [];
  let tableau = `<table>
    <thead><tr>
      <th>Mois</th>
      <th>Capital restant</th>
      <th>Principal</th>
      <th>Intérêt</th>
      <th>Mensualité</th>
    </tr></thead><tbody>`;

  for (let mois = 1; mois <= duree; mois++) {
    let interets, principal, paiement;
    let rowClass = '';
    let adjusted = false;
    
    if (mois <= periodeGrace) {
      // Période de grâce
      interets = capitalRestant * tauxMensuel;
      principal = 0;
      paiement = interets;
      rowClass = 'grace';
    } else {
      // Trouver la mensualité pour ce mois
      const period = sortedPeriods.find(p => mois >= p.startMonth && mois <= p.endMonth);
      
      interets = capitalRestant * tauxMensuel;
      
      if (period && period.amount > 0) {
        let mensualiteDemandee = period.amount;
        
        // Calculer le principal qu'on obtiendrait avec cette mensualité
        let principalCalcule = mensualiteDemandee - interets;
        
        // Vérifier si la mensualité est insuffisante pour couvrir les intérêts
        if (principalCalcule < 0) {
          // Ajuster automatiquement au minimum (intérêts + 1 Ar de principal)
          paiement = interets + 1;
          principal = 1;
          adjusted = true;
          adjustments.push({
            mois: mois,
            demande: mensualiteDemandee,
            ajustee: paiement,
            raison: 'insuffisante pour couvrir les intérêts'
          });
        }
        // Vérifier si le principal dépasse le capital restant
        else if (principalCalcule > capitalRestant) {
          // Ajuster pour rembourser exactement le capital restant
          principal = capitalRestant;
          paiement = principal + interets;
          adjusted = true;
          adjustments.push({
            mois: mois,
            demande: mensualiteDemandee,
            ajustee: paiement,
            raison: 'dépasse le capital restant'
          });
        }
        else {
          // Mensualité valide
          paiement = mensualiteDemandee;
          principal = principalCalcule;
        }
        
        rowClass = adjusted ? 'custom-period grace' : 'custom-period';
      } else {
        // Si pas de période définie, on applique le paiement minimum (intérêts seuls)
        paiement = interets;
        principal = 0;
      }
      
      capitalRestant -= principal;
      
      // Si le capital est remboursé, arrêter les remboursements
      if (capitalRestant < 0.01 && mois < duree) {
        capitalRestant = 0;
      }
    }
    
    tableau += `<tr class="${rowClass}"><td>${mois}</td><td>${formatAriary(Math.max(capitalRestant,0))}</td><td>${formatAriary(principal)}</td><td>${formatAriary(interets)}</td><td>${formatAriary(paiement)}</td></tr>`;
    
    totalPrincipal += principal;
    totalInterets += interets;
    totalMensualites += paiement;
  }

  tableau += `<tr class="total-row"><td>Total</td><td>-</td><td>${formatAriary(totalPrincipal)}</td><td>${formatAriary(totalInterets)}</td><td>${formatAriary(totalMensualites)}</td></tr>`;
  tableau += "</tbody></table>";

  let warningHtml = '';
  let adjustmentHtml = '';
  
  // Afficher les ajustements automatiques
  if (adjustments.length > 0) {
    adjustmentHtml = `<div class="warning-box" style="background: #d1ecf1; border-color: #bee5eb; color: #0c5460;">
      <strong>ℹ️ Ajustements automatiques appliqués :</strong><br>`;
    adjustments.forEach(adj => {
      adjustmentHtml += `• Mois ${adj.mois}: ${formatAriary(adj.demande)} → ${formatAriary(adj.ajustee)} (${adj.raison})<br>`;
    });
    adjustmentHtml += `</div>`;
  }
  
  if (capitalRestant > 1) {
    warningHtml = `<div class="warning-box">
      <strong>⚠️ Attention :</strong> Capital restant dû: ${formatAriary(capitalRestant)}<br>
      Les mensualités personnalisées ne couvrent pas le remboursement total du prêt.
    </div>`;
  } else if (capitalRestant < 0.01) {
    warningHtml = `<div class="warning-box" style="background: #d4edda; border-color: #c3e6cb; color: #155724;">
      <strong>✓ Prêt remboursé intégralement</strong>
    </div>`;
  }

  document.getElementById('result').innerHTML =
    `<div class="summary">
      <b>Produit :</b> ${produit}<br>
      <b>Mode :</b> Mensualités personnalisées<br>
      <b>Montant emprunté :</b> ${formatAriary(montant)}<br>
      <b>Durée :</b> ${duree} mois (${periodeGrace} mois de grâce)<br>
      <b>Taux annuel :</b> ${(taux*100).toFixed(2)}%<br>
      <b>Total intérêts :</b> ${formatAriary(totalInterets)}<br>
      <b>Coût total du crédit :</b> ${formatAriary(totalMensualites)}<br>
      <b>Capital remboursé :</b> ${formatAriary(totalPrincipal)}
    </div>${adjustmentHtml}${warningHtml}`;

  document.getElementById('resultMensualite').innerHTML = 
    `<b>Mode de remboursement :</b> Mensualités personnalisées (voir tableau d'amortissement)`;

  document.getElementById('tableauAmortissement').innerHTML = tableau;
}
</script>
</body>
</html>
