<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulateur de cr√©dit Paositra Finances</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-image: url('background.png');
      background-attachment: fixed;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      font-size: 14px;
      color: #333;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: -1;
      pointer-events: none;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      text-align: center;
    }

    .logo {
      height: 60px;
      max-width: 50%;
    }

    .title {
      font-size: 1.8rem;
      color: #fff;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    @media (max-width: 600px) {
      .title {
        font-size: 1.4rem;
      }

      .logo {
        height: 50px;
      }
    }

    .form-container {
      background: rgba(255, 255, 255, 0.7);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    label {
      font-weight: bold;
      margin-top: 8px;
      display: block;
    }

    select,
    input,
    button {
      padding: 8px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 14px;
      box-sizing: border-box;
    }

    .mode-toggle {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: normal;
    }

    .radio-group input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .custom-payments-section {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .payment-period {
      background: white;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }

    .payment-period-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .payment-period input {
      width: calc(50% - 5px);
      display: inline-block;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
      width: auto;
      margin: 0;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-success {
      background: #28a745;
    }

    .btn-success:hover {
      background: #218838;
    }

    button {
      background: #3498db;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
      border: none;
    }

    button:hover {
      background: #2980b9;
    }

    .result-box {
      background: rgba(255, 255, 255, 0.7);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: none;
    }

    #tableauAmortissement {
      display: none;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      color: #856404;
      font-size: 13px;
    }

    .info-box {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      color: #0c5460;
      font-size: 13px;
    }

    .success-box {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      color: #155724;
      font-size: 13px;
    }

    .btn-print {
      background: #6c757d;
    }

    .btn-print:hover {
      background: #5a6268;
    }

    .actions-bar {
      display: none;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .actions-bar.show {
      display: flex !important;
    }

    .actions-bar button {
      flex: 1;
      min-width: 150px;
    }

    @media print {
      body::before {
        display: none !important;
      }

      body {
        background: white !important;
        padding: 0;
      }

      .form-container,
      .actions-bar,
      button {
        display: none !important;
      }

      .container {
        max-width: 100%;
        margin: 0;
      }

      .result-box {
        background: white !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        border: 1px solid #ddd;
        padding: 10px;
      }

      table {
        background: white !important;
        box-shadow: none !important;
        border: 1px solid #ddd;
      }

      th {
        background: #2c3e50 !important;
        color: white !important;
      }

      .title {
        color: #000;
        text-shadow: none;
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      table-layout: fixed;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: right;
      font-size: 12px;
      overflow: hidden;
    }

    th {
      background: #2c3e50;
      color: white;
      text-align: center;
    }

    td:first-child,
    th:first-child {
      width: 10%;
      text-align: center;
    }

    td:nth-child(2),
    th:nth-child(2) {
      width: 25%;
    }

    td:nth-child(3),
    th:nth-child(3) {
      width: 20%;
    }

    td:nth-child(4),
    th:nth-child(4) {
      width: 20%;
    }

    td:nth-child(5),
    th:nth-child(5) {
      width: 25%;
    }

    tr:nth-child(even) {
      background: #f2f2f2;
    }

    tr:hover {
      background: #eaf2f8;
    }

    .grace {
      background: #ffeeba !important;
    }

    .custom-period {
      background: #d4edda !important;
    }

    .custom-period.grace {
      background: #fff3cd !important;
      border-left: 4px solid #ff9800;
    }

    .total-row {
      font-weight: bold;
      background: #dff0d8;
    }

    .summary {
      font-size: 14px;
      line-height: 1.6;
      text-align: left;
    }

    .export-container {
      display: none;
    }

    .export-container.show {
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1 class="title">Simulateur de cr√©dit Paositra Finances</h1>
    </header>

    <div class="form-container">
      <label for="produit">Choisir un produit :</label>
      <select id="produit" onchange="updateProduit()">
        <option value="">-- S√©lectionnez --</option>
        <option value="KETRIKA">KETRIKA</option>
        <option value="HERIJIKA">HERIJIKA</option>
        <option value="HERIJIKA_PLUS">HERIJIKA PLUS</option>
        <option value="HERIJIKA_PME">HERIJIKA PME</option>
        <option value="AUTRES_PRODUITS">AUTRES PRODUITS</option>
      </select>

      <label for="montant">Montant du pr√™t (Ariary):</label>
      <input type="text" id="montant" inputmode="numeric" />

      <label for="taux">Taux d'int√©r√™t annuel (%):</label>
      <input type="text" id="taux" inputmode="decimal" />

      <label for="duree">Dur√©e (mois):</label>
      <input type="text" id="duree" inputmode="numeric" />

      <label for="periodeGrace">P√©riode de gr√¢ce (mois):</label>
      <input type="text" id="periodeGrace" value="0" inputmode="numeric" />

      <div class="mode-toggle">
        <label style="margin-bottom: 10px;">Mode de remboursement :</label>
        <div class="radio-group">
          <label>
            <input type="radio" name="mode" value="standard" checked onchange="toggleCustomPayments()">
            Mensualit√©s fixes
          </label>
          <label>
            <input type="radio" name="mode" value="custom" onchange="toggleCustomPayments()">
            Mensualit√©s personnalis√©es
          </label>
        </div>
      </div>

      <div id="customPaymentsSection" class="custom-payments-section">
        <h3 style="margin-top: 0;">Configuration des mensualit√©s personnalis√©es</h3>
        <p style="font-size: 12px; color: #666;">D√©finissez diff√©rents montants de mensualit√©s pour diff√©rentes p√©riodes
          de remboursement.</p>

        <div id="paymentPeriods"></div>

        <button type="button" class="btn-success" onclick="addPaymentPeriod()">+ Ajouter une p√©riode</button>
      </div>

      <button onclick="calculer()">Calculer</button>
    </div>

    <div id="result" class="result-box"></div>
    <div id="resultMensualite" class="result-box"></div>
    <div id="tableauAmortissement"></div>

    <div id="actionsContainer" class="actions-bar">
      <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimer et enregistrer au format PDF</button>
    </div>
  </div>

  <script>
    /* ---------- Donn√©es produits ---------- */
    const produits = {
      KETRIKA: { taux: 39, min: 515000, max: 10300000, minDuree: 6, maxDuree: 30 },
      HERIJIKA: { taux: 39, min: 1030000, max: 10300000, minDuree: 6, maxDuree: 24 },
      HERIJIKA_PLUS: { taux: 39, min: 10300001, max: 51500000, minDuree: 6, maxDuree: 24 },
      HERIJIKA_PME: { taux: null, min: 51500001, max: 154500000, minDuree: 6, maxDuree: 24 },
      AUTRES_PRODUITS: { taux: null, min: 0, max: Infinity, minDuree: 1, maxDuree: Infinity }
    };

    let paymentPeriods = [];

    /* ---------- UTILITAIRES de formatage / parsing ---------- */

    function formatInputInteger(value) {
      if (value === "" || value === null || isNaN(value)) return "";
      const n = Math.round(Number(value));
      return n.toLocaleString('fr-FR').replace(/\u202F/g, ' ');
    }
    function formatInputTaux(value) {
      if (value === "" || value === null || isNaN(value)) return "";
      return Number(value).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    function formatAriary(val) {
      if (val === null || val === undefined || isNaN(val)) return "0 Ar";
      const n = Number(val);
      return n.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/\u202F/g, ' ') + " Ar";
    }

    function parseNumberFromString(str) {
      if (str === null || str === undefined) return NaN;
      const cleaned = String(str).replace(/\s/g, '').replace(/\u00A0/g, '').replace(/,/g, '.').replace(/[^\d.\-]/g, '');
      if (cleaned === "" || cleaned === "-" || cleaned === ".") return NaN;
      return Number(cleaned);
    }

    /* ---------- Mise √† jour produit ---------- */
    function updateProduit() {
      const produit = document.getElementById('produit').value;
      const tauxInput = document.getElementById('taux');
      if (produit && produits[produit].taux !== null) {
        tauxInput.dataset.raw = produits[produit].taux;
        tauxInput.value = formatInputTaux(produits[produit].taux);
        tauxInput.disabled = true;
      } else {
        tauxInput.dataset.raw = "";
        tauxInput.value = "";
        tauxInput.disabled = false;
      }
    }

    /* ---------- Gestion du mode et p√©riodes personnalis√©es ---------- */
    function toggleCustomPayments() {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const section = document.getElementById('customPaymentsSection');

      if (mode === 'custom') {
        section.style.display = 'block';
        if (paymentPeriods.length === 0) {
          addPaymentPeriod();
        }
      } else {
        section.style.display = 'none';
      }
    }

    function addPaymentPeriod() {
      const id = Date.now() + Math.floor(Math.random() * 1000);
      paymentPeriods.push({ id, startMonth: 1, endMonth: 1, amount: 0 });
      renderPaymentPeriods();
    }

    function removePaymentPeriod(id) {
      paymentPeriods = paymentPeriods.filter(p => p.id !== id);
      renderPaymentPeriods();
    }

    function renderPaymentPeriods() {
      const container = document.getElementById('paymentPeriods');
      container.innerHTML = paymentPeriods.map((period, index) => `
    <div class="payment-period" data-id="${period.id}">
      <div class="payment-period-header">
        <strong>P√©riode ${index + 1}</strong>
        ${paymentPeriods.length > 1 ? `<button type="button" class="btn-small btn-danger" data-remove="${period.id}">Supprimer</button>` : ''}
      </div>
      <label style="font-weight: normal; font-size: 12px;">Du mois</label>
      <input type="text" class="custom-month" data-field="startMonth" value="${formatInputInteger(period.startMonth)}">
      <label style="font-weight: normal; font-size: 12px; margin-top: 5px;">Au mois</label>
      <input type="text" class="custom-month" data-field="endMonth" value="${formatInputInteger(period.endMonth)}">
      <label style="font-weight: normal; font-size: 12px; margin-top: 5px;">Mensualit√© (Ariary)</label>
      <input type="text" class="custom-amount" data-field="amount" value="${formatInputInteger(period.amount)}">
    </div>
  `).join('');

      container.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = Number(btn.getAttribute('data-remove'));
          removePaymentPeriod(id);
        });
      });

      container.querySelectorAll('.custom-month').forEach(inp => {
        inp.addEventListener('input', (e) => {
          let raw = e.target.value;
          let parsed = parseNumberFromString(raw);
          if (isNaN(parsed)) parsed = "";
          e.target.value = parsed === "" ? "" : formatInputInteger(parsed);
          const parent = e.target.closest('.payment-period');
          const id = Number(parent.getAttribute('data-id'));
          const field = e.target.dataset.field;
          updatePeriod(id, field, parsed);
        });
        inp.addEventListener('blur', (e) => {
          if (e.target.value.trim() === "") {
            e.target.value = formatInputInteger(1);
            const parent = e.target.closest('.payment-period');
            const id = Number(parent.getAttribute('data-id'));
            updatePeriod(id, e.target.dataset.field, 1);
          }
        });
      });

      container.querySelectorAll('.custom-amount').forEach(inp => {
        inp.addEventListener('input', (e) => {
          let raw = e.target.value;
          let parsed = parseNumberFromString(raw);
          if (isNaN(parsed)) parsed = "";
          e.target.value = parsed === "" ? "" : formatInputInteger(parsed);
          const parent = e.target.closest('.payment-period');
          const id = Number(parent.getAttribute('data-id'));
          updatePeriod(id, e.target.dataset.field, parsed);
        });
        inp.addEventListener('blur', (e) => {
          if (e.target.value.trim() === "") {
            e.target.value = formatInputInteger(0);
            const parent = e.target.closest('.payment-period');
            const id = Number(parent.getAttribute('data-id'));
            updatePeriod(id, e.target.dataset.field, 0);
          }
        });
      });
    }

    function updatePeriod(id, field, value) {
      const period = paymentPeriods.find(p => p.id === id);
      if (period) {
        if (field === 'amount') {
          period[field] = isNaN(Number(value)) ? 0 : Number(value);
        } else {
          period[field] = isNaN(Number(value)) ? 1 : Math.max(1, Math.floor(Number(value)));
        }
      }
    }

    /* ---------- Formatage et nettoyage des inputs principaux ---------- */
    const mainNumericIdsInteger = ["montant", "duree", "periodeGrace"];
    const mainNumericIdsTaux = ["taux"];

    mainNumericIdsInteger.forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener('input', (e) => {
        let raw = e.target.value;
        let parsed = parseNumberFromString(raw);
        if (isNaN(parsed)) {
          e.target.value = raw.replace(/[^\d\s]/g, '');
          return;
        }
        e.target.value = formatInputInteger(parsed);
      });
      input.addEventListener('blur', (e) => {
        let parsed = parseNumberFromString(e.target.value);
        if (isNaN(parsed)) parsed = 0;
        e.target.value = formatInputInteger(parsed);
      });
    });

    mainNumericIdsTaux.forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener('input', (e) => {
        let raw = e.target.value;
        let parsed = parseNumberFromString(raw);
        if (isNaN(parsed)) {
          e.target.value = raw.replace(/[^\d,.\s]/g, '');
          return;
        }
      });
      input.addEventListener('blur', (e) => {
        let parsed = parseNumberFromString(e.target.value);
        if (isNaN(parsed)) parsed = 0;
        e.target.value = formatInputTaux(parsed);
      });
    });

    /* ---------- R√©cup√©ration des valeurs pour calculs ---------- */
    function getInputNumberInteger(id) {
      const el = document.getElementById(id);
      return parseNumberFromString(el.value);
    }
    function getTauxNumber(id) {
      const el = document.getElementById(id);
      if (el.disabled && el.dataset.raw) {
        return Number(el.dataset.raw);
      }
      return parseNumberFromString(el.value);
    }

    /* ---------- Export PDF ---------- */
    function exportPDF() {
      const element = document.querySelector('.container');
      const opt = {
        margin: 10,
        filename: 'simulation-credit-paositra.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };
      html2pdf().set(opt).from(element).save();
    }

    /* ---------- Calculs ---------- */

    function calculer() {
      const produit = document.getElementById('produit').value;
      const montant = getInputNumberInteger('montant');
      const tauxAnnuelPourcent = getTauxNumber('taux');
      const taux = tauxAnnuelPourcent / 100;
      const duree = Math.floor(getInputNumberInteger('duree'));
      const periodeGrace = Math.floor(getInputNumberInteger('periodeGrace'));
      const mode = document.querySelector('input[name="mode"]:checked').value;

      if (!produit || isNaN(montant) || isNaN(taux) || isNaN(duree)) {
        alert("Veuillez remplir tous les champs correctement.");
        return;
      }
      if (periodeGrace >= duree) {
        alert("La p√©riode de gr√¢ce doit √™tre inf√©rieure √† la dur√©e.");
        return;
      }

      const conditions = produits[produit];

      // V√©rifications sp√©cifiques pour "AUTRES PRODUITS"
      if (produit === 'AUTRES_PRODUITS') {
        if (montant <= 0) {
          alert("Le montant du pr√™t doit √™tre positif.");
          return;
        }
        if (duree < 1) {
          alert("La dur√©e doit √™tre au minimum 1 mois.");
          return;
        }
      } else {
        // V√©rifications pour les autres produits
        if (montant < conditions.min || montant > conditions.max || duree < conditions.minDuree || duree > conditions.maxDuree) {
          alert(`Conditions non respect√©es pour ${produit}. Montant: ${formatAriary(conditions.min)} √† ${formatAriary(conditions.max)}, Dur√©e: ${conditions.minDuree} √† ${conditions.maxDuree} mois.`);
          return;
        }
      }

      const tauxMensuel = taux / 12;
      const dureeRestante = duree - periodeGrace;

      // Afficher les r√©sultats
      document.getElementById('result').style.display = 'block';
      document.getElementById('resultMensualite').style.display = 'block';
      document.getElementById('tableauAmortissement').style.display = 'block';
      document.getElementById('actionsContainer').classList.add('show');

      if (mode === 'standard') {
        calculerModeStandard(montant, tauxMensuel, duree, periodeGrace, dureeRestante, produit, taux);
      } else {
        calculerModePersonnalise(montant, tauxMensuel, duree, periodeGrace, produit, taux);
      }
    }

    function calculerModeStandard(montant, tauxMensuel, duree, periodeGrace, dureeRestante, produit, taux) {
      const mensualite = montant * tauxMensuel / (1 - Math.pow(1 + tauxMensuel, -dureeRestante));

      let capitalRestant = montant;
      let totalPrincipal = 0, totalInterets = 0, totalMensualites = 0;
      let tableau = `<table>
    <thead><tr>
      <th>Mois</th>
      <th>Capital restant</th>
      <th>Principal</th>
      <th>Int√©r√™t</th>
      <th>Mensualit√©</th>
    </tr></thead><tbody>`;

      for (let mois = 1; mois <= duree; mois++) {
        let interets = 0, principal = 0, paiement = 0;
        if (mois <= periodeGrace) {
          interets = capitalRestant * tauxMensuel;
          principal = 0;
          paiement = interets;
          tableau += `<tr class="grace"><td>${mois}</td><td>${formatAriary(capitalRestant)}</td><td>${formatAriary(principal)}</td><td>${formatAriary(interets)}</td><td>${formatAriary(paiement)}</td></tr>`;
        } else {
          interets = capitalRestant * tauxMensuel;
          principal = mensualite - interets;
          if (principal > capitalRestant) principal = capitalRestant;
          capitalRestant -= principal;
          paiement = principal + interets;
          tableau += `<tr><td>${mois}</td><td>${formatAriary(Math.max(capitalRestant, 0))}</td><td>${formatAriary(principal)}</td><td>${formatAriary(interets)}</td><td>${formatAriary(paiement)}</td></tr>`;
        }
        totalPrincipal += principal;
        totalInterets += interets;
        totalMensualites += paiement;
      }

      tableau += `<tr class="total-row"><td>Total</td><td>-</td><td>${formatAriary(totalPrincipal)}</td><td>${formatAriary(totalInterets)}</td><td>${formatAriary(totalMensualites)}</td></tr>`;
      tableau += "</tbody></table>";

      document.getElementById('result').innerHTML =
        `<div class="summary">
      <b>Produit :</b> ${produit}<br>
      <b>Montant emprunt√© :</b> ${formatAriary(montant)}<br>
      <b>Dur√©e :</b> ${duree} mois (${periodeGrace} mois de gr√¢ce)<br>
      <b>Taux annuel :</b> ${(taux * 100).toFixed(2)}%<br>
      <b>Total int√©r√™ts :</b> ${formatAriary(totalInterets)}<br>
      <b>Co√ªt total du cr√©dit :</b> ${formatAriary(totalMensualites)}
    </div>`;

      document.getElementById('resultMensualite').innerHTML =
        `<b>Mensualit√© apr√®s p√©riode de gr√¢ce :</b> ${formatAriary(mensualite)}`;

      document.getElementById('tableauAmortissement').innerHTML = tableau;
    }

    function calculerModePersonnalise(montant, tauxMensuel, duree, periodeGrace, produit, taux) {
      const sortedPeriods = [...paymentPeriods].sort((a, b) => a.startMonth - b.startMonth);

      for (let period of sortedPeriods) {
        if (period.startMonth < 1 || period.endMonth > duree || period.startMonth > period.endMonth) {
          alert("Les p√©riodes de paiement doivent √™tre valides et dans la dur√©e du pr√™t.");
          return;
        }
        if (period.startMonth <= periodeGrace) {
          alert("Les p√©riodes de paiement personnalis√©es ne peuvent pas commencer pendant la p√©riode de gr√¢ce.");
          return;
        }
      }

      let capitalRestant = montant;
      let totalPrincipal = 0, totalInterets = 0, totalMensualites = 0;
      let adjustments = [];
      let tableau = `<table>
    <thead><tr>
      <th>Mois</th>
      <th>Capital restant</th>
      <th>Principal</th>
      <th>Int√©r√™t</th>
      <th>Mensualit√©</th>
    </tr></thead><tbody>`;

      for (let mois = 1; mois <= duree; mois++) {
        let interets = 0, principal = 0, paiement = 0;
        let rowClass = '';
        let adjusted = false;

        if (mois <= periodeGrace) {
          interets = capitalRestant * tauxMensuel;
          principal = 0;
          paiement = interets;
          rowClass = 'grace';
        } else {
          const period = sortedPeriods.find(p => mois >= p.startMonth && mois <= p.endMonth);

          interets = capitalRestant * tauxMensuel;

          if (period && period.amount > 0) {
            let mensualiteDemandee = Number(period.amount);
            let principalCalcule = mensualiteDemandee - interets;

            if (principalCalcule < 0) {
              paiement = interets + 1;
              principal = 1;
              adjusted = true;
              adjustments.push({
                mois: mois,
                demande: mensualiteDemandee,
                ajustee: paiement,
                raison: 'insuffisante pour couvrir les int√©r√™ts'
              });
            }
            else if (principalCalcule > capitalRestant) {
              principal = capitalRestant;
              paiement = principal + interets;
              adjusted = true;
              adjustments.push({
                mois: mois,
                demande: mensualiteDemandee,
                ajustee: paiement,
                raison: 'd√©passe le capital restant'
              });
            }
            else {
              paiement = mensualiteDemandee;
              principal = principalCalcule;
            }

            rowClass = adjusted ? 'custom-period grace' : 'custom-period';
          } else {
            paiement = interets;
            principal = 0;
          }

          capitalRestant -= principal;
          if (capitalRestant < 0.01 && mois < duree) {
            capitalRestant = 0;
          }
        }

        tableau += `<tr class="${rowClass}"><td>${mois}</td><td>${formatAriary(Math.max(capitalRestant, 0))}</td><td>${formatAriary(principal)}</td><td>${formatAriary(interets)}</td><td>${formatAriary(paiement)}</td></tr>`;

        totalPrincipal += principal;
        totalInterets += interets;
        totalMensualites += paiement;
      }

      tableau += `<tr class="total-row"><td>Total</td><td>-</td><td>${formatAriary(totalPrincipal)}</td><td>${formatAriary(totalInterets)}</td><td>${formatAriary(totalMensualites)}</td></tr>`;
      tableau += "</tbody></table>";

      let warningHtml = '';
      let adjustmentHtml = '';

      if (adjustments.length > 0) {
        adjustmentHtml = `<div class="warning-box" style="background: #d1ecf1; border-color: #bee5eb; color: #0c5460;">
      <strong>‚ÑπÔ∏è Ajustements automatiques appliqu√©s :</strong><br>`;
        adjustments.forEach(adj => {
          adjustmentHtml += `‚Ä¢ Mois ${adj.mois}: ${formatAriary(adj.demande)} ‚Üí ${formatAriary(adj.ajustee)} (${adj.raison})<br>`;
        });
        adjustmentHtml += `</div>`;
      }

      if (capitalRestant > 1) {
        warningHtml = `<div class="warning-box">
      <strong>‚ö†Ô∏è Attention :</strong> Capital restant d√ª: ${formatAriary(capitalRestant)}<br>
      Les mensualit√©s personnalis√©es ne couvrent pas le remboursement total du pr√™t.
    </div>`;
      } else if (capitalRestant < 0.01) {
        warningHtml = `<div class="warning-box" style="background: #d4edda; border-color: #c3e6cb; color: #155724;">
      <strong>‚úì Pr√™t rembours√© int√©gralement</strong>
    </div>`;
      }

      document.getElementById('result').innerHTML =
        `<div class="summary">
      <b>Produit :</b> ${produit}<br>
      <b>Mode :</b> Mensualit√©s personnalis√©es<br>
      <b>Montant emprunt√© :</b> ${formatAriary(montant)}<br>
      <b>Dur√©e :</b> ${duree} mois (${periodeGrace} mois de gr√¢ce)<br>
      <b>Taux annuel :</b> ${(taux * 100).toFixed(2)}%<br>
      <b>Total int√©r√™ts :</b> ${formatAriary(totalInterets)}<br>
      <b>Co√ªt total du cr√©dit :</b> ${formatAriary(totalMensualites)}<br>
      <b>Capital rembours√© :</b> ${formatAriary(totalPrincipal)}
    </div>${adjustmentHtml}${warningHtml}`;

      document.getElementById('resultMensualite').innerHTML =
        `<b>Mode de remboursement :</b> Mensualit√©s personnalis√©es (voir tableau d'amortissement)`;

      document.getElementById('tableauAmortissement').innerHTML = tableau;
    }

    /* ---------- Initialisation ---------- */
    updateProduit();
    document.addEventListener('DOMContentLoaded', () => {
      mainNumericIdsInteger.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.value.trim() !== "") {
          const parsed = parseNumberFromString(el.value);
          if (!isNaN(parsed)) el.value = formatInputInteger(parsed);
        }
      });
      const tauxEl = document.getElementById('taux');
      if (tauxEl && tauxEl.value.trim() !== "") {
        const parsed = parseNumberFromString(tauxEl.value);
        if (!isNaN(parsed)) tauxEl.value = formatInputTaux(parsed);
      }
    });
  </script>
